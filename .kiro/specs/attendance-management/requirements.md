# 要件定義書

## はじめに

本ドキュメントは、Spring Boot初学者向けの勤怠管理アプリケーションの要件を定義します。このアプリケーションは、基本的なMVCパターン、依存性注入（DI）、Bean管理などSpring Bootの基本概念を学ぶことを目的としています。振る舞い駆動開発（BDD）のアプローチを採用し、Given-When-Then記法で要件を明確化します。

## 用語集

- **システム**: 勤怠管理アプリケーション全体を指す
- **従業員**: 勤怠を記録する利用者
- **出勤記録**: 従業員の出勤時刻を記録したデータ
- **退勤記録**: 従業員の退勤時刻を記録したデータ
- **勤怠レコード**: 出勤時刻と退勤時刻を含む1日分の勤怠データ
- **勤怠リポジトリ**: 勤怠データの永続化を担当するコンポーネント
- **勤怠サービス**: 勤怠に関するビジネスロジックを担当するコンポーネント
- **勤怠コントローラ**: HTTPリクエストを処理し、ビューとモデルを制御するコンポーネント
- **ユーザー**: システムにログインして勤怠を記録する認証済みの従業員
- **認証**: ユーザー名とパスワードによる本人確認プロセス
- **セッション**: ログイン後のユーザー状態を維持する仕組み

## 要件

### 要件1: 従業員の出勤記録

**ユーザーストーリー:** 従業員として、出勤時刻を記録したい。そうすることで、勤務開始時刻を正確に管理できる。

#### 受け入れ基準

1. WHEN 従業員が出勤ボタンをクリックしたとき、システムは現在時刻を出勤時刻として記録する
2. WHEN 出勤記録が作成されたとき、システムは従業員ID、出勤日、出勤時刻を含む勤怠レコードを生成する
3. WHEN 出勤記録が正常に保存されたとき、システムは成功メッセージを表示する
4. IF 同じ日に既に出勤記録が存在する場合、THEN システムはエラーメッセージを表示し、重複登録を防止する

### 要件2: 従業員の退勤記録

**ユーザーストーリー:** 従業員として、退勤時刻を記録したい。そうすることで、勤務終了時刻を正確に管理できる。

#### 受け入れ基準

1. WHEN 従業員が退勤ボタンをクリックしたとき、システムは現在時刻を退勤時刻として記録する
2. WHEN 退勤記録が更新されたとき、システムは既存の勤怠レコードに退勤時刻を追加する
3. WHEN 退勤記録が正常に保存されたとき、システムは成功メッセージを表示する
4. IF 当日の出勤記録が存在しない場合、THEN システムはエラーメッセージを表示し、退勤記録を拒否する
5. IF 既に退勤記録が存在する場合、THEN システムはエラーメッセージを表示し、重複登録を防止する

### 要件3: 勤怠履歴の表示

**ユーザーストーリー:** 従業員として、自分の勤怠履歴を確認したい。そうすることで、過去の勤務状況を把握できる。

#### 受け入れ基準

1. WHEN 従業員が勤怠履歴ページにアクセスしたとき、システムはその従業員の全勤怠レコードを日付降順で表示する
2. WHEN 勤怠レコードを表示するとき、システムは日付、出勤時刻、退勤時刻、勤務時間を表示する
3. WHEN 退勤時刻が未記録の勤怠レコードを表示するとき、システムは退勤時刻を「未退勤」と表示する
4. WHEN 勤怠履歴が存在しないとき、システムは「勤怠記録がありません」というメッセージを表示する

### 要件4: 勤務時間の自動計算

**ユーザーストーリー:** 従業員として、勤務時間が自動計算されることを期待する。そうすることで、手動計算の手間を省ける。

#### 受け入れ基準

1. WHEN 出勤時刻と退勤時刻が両方記録されているとき、システムは勤務時間を時間単位で計算する
2. WHEN 勤務時間を計算するとき、システムは退勤時刻から出勤時刻を減算した結果を使用する
3. WHEN 勤務時間を表示するとき、システムは時間と分の形式（例: 8時間30分）で表示する
4. WHEN 退勤時刻が未記録のとき、システムは勤務時間を計算しない

### 要件5: データの永続化

**ユーザーストーリー:** システム管理者として、勤怠データが永続的に保存されることを期待する。そうすることで、アプリケーション再起動後もデータが失われない。

#### 受け入れ基準

1. WHEN 勤怠レコードが作成または更新されたとき、勤怠リポジトリはデータをデータベースに保存する
2. WHEN アプリケーションが再起動されたとき、システムは以前に保存された全ての勤怠レコードを取得できる
3. WHEN データベース操作が失敗したとき、システムはエラーメッセージを表示し、ユーザーに通知する

### 要件6: MVCアーキテクチャの実装

**ユーザーストーリー:** 開発者として、MVCパターンに従った実装を期待する。そうすることで、コードの保守性と理解しやすさが向上する。

#### 受け入れ基準

1. システムはコントローラ層、サービス層、リポジトリ層の3層アーキテクチャを実装する
2. 勤怠コントローラはHTTPリクエストを受け取り、適切なサービスメソッドを呼び出す
3. 勤怠サービスはビジネスロジックを実装し、リポジトリを通じてデータアクセスを行う
4. 勤怠リポジトリはデータベースとのやり取りのみを担当する
5. システムはThymeleafテンプレートエンジンを使用してビューを実装する

### 要件7: 依存性注入とBean管理

**ユーザーストーリー:** 開発者として、Spring BootのDIコンテナを活用した実装を期待する。そうすることで、疎結合で拡張性の高いコードを実現できる。

#### 受け入れ基準

1. システムは@Serviceアノテーションを使用してサービスクラスをBean登録する
2. システムは@Repositoryアノテーションを使用してリポジトリクラスをBean登録する
3. システムは@Controllerアノテーションを使用してコントローラクラスをBean登録する
4. システムはコンストラクタインジェクションを使用して依存関係を注入する
5. システムはインターフェースと実装クラスを分離し、疎結合を実現する

### 要件8: エラーハンドリング

**ユーザーストーリー:** 従業員として、エラーが発生したときに分かりやすいメッセージを受け取りたい。そうすることで、問題を理解し適切に対応できる。

#### 受け入れ基準

1. WHEN ビジネスルール違反が発生したとき、システムはカスタム例外をスローする
2. WHEN 例外が発生したとき、システムはユーザーフレンドリーなエラーメッセージを表示する
3. WHEN データベースエラーが発生したとき、システムは技術的な詳細を隠し、一般的なエラーメッセージを表示する
4. システムはエラーメッセージをビューに渡し、適切に表示する

### 要件9: 入力バリデーション

**ユーザーストーリー:** システム管理者として、不正なデータが保存されないことを期待する。そうすることで、データの整合性を保つことができる。

#### 受け入れ基準

1. WHEN 従業員IDが提供されないとき、システムはエラーメッセージを表示し、処理を中断する
2. WHEN 出勤時刻が未来の時刻のとき、システムはエラーメッセージを表示し、記録を拒否する
3. WHEN 退勤時刻が出勤時刻より前のとき、システムはエラーメッセージを表示し、記録を拒否する
4. システムはサービス層でビジネスルールのバリデーションを実行する

### 要件10: シンプルなユーザーインターフェース

**ユーザーストーリー:** 従業員として、直感的で使いやすいインターフェースを期待する。そうすることで、迷わず操作できる。

#### 受け入れ基準

1. システムはホームページに出勤ボタンと退勤ボタンを表示する
2. システムは勤怠履歴へのナビゲーションリンクを提供する
3. WHEN ボタンがクリックされたとき、システムは操作結果を明確に表示する
4. システムはレスポンシブデザインを使用せず、デスクトップ向けのシンプルなレイアウトを提供する

### 要件11: ユーザー認証とログイン

**ユーザーストーリー:** 従業員として、ユーザー名とパスワードでログインしたい。そうすることで、自分の勤怠情報を安全に管理できる。

#### 受け入れ基準

1. WHEN ユーザーがログインページにアクセスしたとき、システムはユーザー名とパスワードの入力フォームを表示する
2. WHEN ユーザーが正しいユーザー名とパスワードを入力したとき、システムは認証を成功させ、ホームページにリダイレクトする
3. WHEN ユーザーが誤ったユーザー名またはパスワードを入力したとき、システムはエラーメッセージを表示し、ログインを拒否する
4. WHEN 認証されていないユーザーが勤怠管理機能にアクセスしようとしたとき、システムはログインページにリダイレクトする
5. システムはSpring Securityを使用して認証機能を実装する

### 要件12: ユーザー登録

**ユーザーストーリー:** 新規従業員として、アカウントを登録したい。そうすることで、システムを利用開始できる。

#### 受け入れ基準

1. WHEN ユーザーが登録ページにアクセスしたとき、システムはユーザー名、パスワード、従業員IDの入力フォームを表示する
2. WHEN ユーザーが有効な情報を入力して登録ボタンをクリックしたとき、システムは新規ユーザーを作成し、ログインページにリダイレクトする
3. WHEN ユーザーが既に存在するユーザー名で登録しようとしたとき、システムはエラーメッセージを表示し、登録を拒否する
4. WHEN 必須項目が入力されていないとき、システムはエラーメッセージを表示し、登録を拒否する
5. システムは登録成功後、ユーザーに成功メッセージを表示する

### 要件13: パスワードの安全な管理

**ユーザーストーリー:** システム管理者として、パスワードが安全に保存されることを期待する。そうすることで、セキュリティリスクを最小化できる。

#### 受け入れ基準

1. WHEN ユーザーが登録またはパスワード変更を行ったとき、システムはパスワードをBCryptアルゴリズムで暗号化する
2. システムは平文パスワードをデータベースに保存しない
3. WHEN ユーザーがログインしたとき、システムは入力されたパスワードを暗号化されたパスワードと照合する
4. システムはパスワードエンコーダーをBeanとして登録し、DIコンテナで管理する

### 要件14: セッション管理とログアウト

**ユーザーストーリー:** 従業員として、ログアウト機能を使用したい。そうすることで、共有端末でも安全にシステムを利用できる。

#### 受け入れ基準

1. WHEN ユーザーがログインに成功したとき、システムはセッションを作成し、ユーザー情報を保持する
2. WHEN ユーザーがログアウトボタンをクリックしたとき、システムはセッションを無効化し、ログインページにリダイレクトする
3. WHEN ログアウト後にユーザーが勤怠管理機能にアクセスしようとしたとき、システムはログインページにリダイレクトする
4. システムはログアウト成功後、ユーザーに成功メッセージを表示する

### 要件15: ログインユーザーに基づく勤怠記録

**ユーザーストーリー:** 従業員として、ログイン後は自動的に自分の従業員IDが使用されることを期待する。そうすることで、従業員IDを毎回入力する手間が省ける。

#### 受け入れ基準

1. WHEN ログインユーザーが出勤ボタンをクリックしたとき、システムはログインユーザーの従業員IDを使用して出勤記録を作成する
2. WHEN ログインユーザーが退勤ボタンをクリックしたとき、システムはログインユーザーの従業員IDを使用して退勤記録を更新する
3. WHEN ログインユーザーが勤怠履歴ページにアクセスしたとき、システムはログインユーザーの従業員IDに紐づく勤怠レコードのみを表示する
4. システムはPrincipalオブジェクトからログインユーザー情報を取得する

